<!DOCTYPE html>
<html>
<head>
    <title>Rose Tracker - Real-time Stream</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .stream-container {
            background: #fff;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: inline-block;
            position: relative;
        }
        #videoStream, #localVideo {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
        }
        .controls {
            margin: 20px 0;
        }
        button {
            padding: 10px 20px;
            margin: 0 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        #startButton {
            background-color: #4CAF50;
            color: white;
        }
        #stopButton {
            background-color: #f44336;
            color: white;
        }
        button:hover {
            opacity: 0.9;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            opacity: 0.7;
        }
        #status {
            font-size: 18px;
            margin: 20px 0;
            color: #666;
        }
        #roseCount {
            font-size: 24px;
            font-weight: bold;
            color: #2196F3;
            margin: 20px 0;
        }
        #localVideo {
            display: none; /* Hide the local video feed */
        }
        .camera-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Real-time Rose Tracking</h1>
        <div class="stream-container">
            <video id="localVideo" autoplay muted></video>
            <img id="videoStream" alt="Real-time Rose Tracking">
            <div class="camera-overlay" id="fpsCounter">FPS: 0</div>
        </div>
        <div class="loader" id="loader"></div>
        <div id="roseCount">Total Roses: <span id="count">0</span></div>
        <div id="status">Status: <span id="trackingStatus">Camera Inactive</span></div>
        <div class="controls">
            <button id="startButton" onclick="startCamera()">Start Camera</button>
            <button id="stopButton" onclick="stopCamera()" disabled>Stop Camera</button>
        </div>
    </div>

    <script>
        // Global variables
        let localStream = null;
        let videoElement = document.getElementById('localVideo');
        let canvas = document.createElement('canvas');
        let canvasContext = canvas.getContext('2d');
        let isTracking = false;
        let lastFrameTime = 0;
        let frameCount = 0;
        let fps = 0;
        let processingFrame = false;

        // Start the camera
        async function startCamera() {
            try {
                document.getElementById('loader').style.display = 'block';
                document.getElementById('trackingStatus').textContent = 'Starting camera...';
                
                // Get user media
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'environment' // Prefer back camera on mobile
                    }
                });
                
                // Set up video element with stream
                videoElement.srcObject = localStream;
                
                // Wait for video to be ready
                await new Promise(resolve => {
                    videoElement.onloadedmetadata = () => {
                        canvas.width = videoElement.videoWidth;
                        canvas.height = videoElement.videoHeight;
                        resolve();
                    };
                });
                
                document.getElementById('trackingStatus').textContent = 'Camera Active - Tracking';
                document.getElementById('startButton').disabled = true;
                document.getElementById('stopButton').disabled = false;
                document.getElementById('loader').style.display = 'none';
                
                // Start sending frames
                isTracking = true;
                requestAnimationFrame(processFrame);
                
                // Start FPS counter
                setInterval(updateFPS, 1000);
            } catch (error) {
                console.error('Error accessing camera:', error);
                document.getElementById('trackingStatus').textContent = `Error: ${error.message}`;
                document.getElementById('loader').style.display = 'none';
            }
        }

        // Stop the camera
        function stopCamera() {
            isTracking = false;
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            document.getElementById('videoStream').src = '';
            document.getElementById('trackingStatus').textContent = 'Camera Stopped';
            document.getElementById('startButton').disabled = false;
            document.getElementById('stopButton').disabled = true;
        }

        // Process and send video frames
        async function processFrame() {
            if (!isTracking) return;
            
            // Throttle frame processing to avoid overloading the server
            if (!processingFrame) {
                processingFrame = true;
                
                try {
                    // Draw video frame to canvas
                    canvasContext.drawImage(videoElement, 0, 0);
                    
                    // Convert to base64 for sending to server
                    const imageData = canvas.toDataURL('image/jpeg', 0.8);
                    
                    // Send to server for processing
                    const response = await fetch('/track/realtime/webcam', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ image: imageData })
                    });
                    
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        // Display processed frame
                        document.getElementById('videoStream').src = result.image;
                        
                        // Update rose count
                        document.getElementById('count').textContent = result.count.count;
                        
                        // Update FPS stats
                        frameCount++;
                        const now = performance.now();
                        if (now - lastFrameTime >= 1000) {
                            fps = Math.round((frameCount * 1000) / (now - lastFrameTime));
                            lastFrameTime = now;
                            frameCount = 0;
                        }
                    }
                } catch (error) {
                    console.error('Error processing frame:', error);
                }
                
                processingFrame = false;
            }
            
            // Request next frame
            requestAnimationFrame(processFrame);
        }

        // Update FPS counter
        function updateFPS() {
            if (isTracking) {
                document.getElementById('fpsCounter').textContent = `FPS: ${fps}`;
            }
        }

        // Clean up on page unload
        window.addEventListener('beforeunload', stopCamera);
    </script>
</body>
</html>